/*!
Copyright 2013 @greweb
http://github.com/gre/glsl.js

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
(function(){function l(a){console.warn?console.warn(m+a):console.log&&console.log(m+("WARN "+a))}function q(a){console.error?console.error(m+a):console.log&&console.log(m+("ERR "+a))}function r(a){if(a.getContext)for(var b=["webgl","experimental-webgl"],c=0;c<b.length;++c)try{var e=a.getContext(b[c]);if(e)return e}catch(d){}}var n=["fragment","canvas","variables"],s={bool:"1i","int":"1i","float":"1f",vec2:"2f",ivec2:"2i",bvec2:"2b",vec3:"3f",ivec3:"3i",bvec3:"3b",vec4:"4f",ivec4:"4i",bvec4:"4b",mat2:"Matrix2fv",
mat3:"Matrix3fv",mat4:"Matrix4fv"},u=/uniform\s+([a-z]+\s+)?([A-Za-z0-9]+)\s+([a-zA-Z_0-9]+)\s*(\[([0-9]+)\])?/,v=/struct\s+\w+\s*{[^}]+}\s*;/g,w=/struct\s+(\w+)\s*{([^}]+)}\s*;/,x=/[^;]+;/g,y=/\s*([a-z]+\s+)?([A-Za-z0-9]+)\s+([a-zA-Z_0-9]+)\s*(\[([0-9]+)\])?\s*;/,m="Glsl: ";this.Glsl=function(a){if(!(this instanceof arguments.callee))return new arguments.callee(a);if(!a)throw Error("Glsl: {"+n+"} are required.");for(var b=0;b<n.length;b++)if(!(n[b]in a))throw Error("Glsl: '"+n[b]+"' is required.");
this.canvas=a.canvas;this.fragment=a.fragment;this.variables=a.variables;this.update=a.update||function(){};this.parseStructs();this.parseUniforms();if(!this.uniformTypes.resolution)throw Error("Glsl: You must use a 'vec2 resolution' in your shader.");delete this.uniformTypes.resolution;for(var c in this.uniformTypes)c in this.variables||l("variable '"+c+"' not initialized");this.initGL();this.load();this.syncAll();a.init&&a.init.call(this);this.update(0,0);this.render()};Glsl.supported=function(){return!!r(document.createElement("canvas"))};
Glsl.prototype={start:function(){var a=Date.now(),b=0,c=this;this.running=!0;requestAnimationFrame(function d(){if(this.stopRequest)this.running=this.stopRequest=!1;else{requestAnimationFrame(d,c.canvas);var f=Date.now()-a,g=f-b;b=f;c.update(f,g);c.render()}},c.canvas);return this},stop:function(){this.stopRequest=!0},sync:function(){for(var a=0;a<arguments.length;++a)this.syncVariable(arguments[a])},syncAll:function(){for(var a in this.variables)this.syncVariable(a)},set:function(a,b){this.variables[a]=
b;this.sync(a)},initGL:function(){var a=this;this.canvas.addEventListener("webglcontextlost",function(a){a.preventDefault()},!1);this.canvas.addEventListener("webglcontextrestored",function(){a.running&&a.syncAll();a.load()},!1);this.gl=this.getWebGLContext(this.canvas)},render:function(){this.gl.drawArrays(this.gl.TRIANGLES,0,6)},parseStructs:function(){this.structTypes={};var a=this.fragment.match(v);if(a)for(var b=0;b<a.length;++b){for(var c=a[b].match(w),e=c[1],c=c[2].match(x),d={},f=0;f<c.length;++f){var g=
c[f].match(y),j=g[2],h=g[3],g=g[4],j=s[j]||j;g&&(j=[j,parseInt(g,10)]);d[h]=j}this.structTypes[e]=d}},parseUniforms:function(){this.uniformTypes={};for(var a=this.fragment.split("\n"),b=0;b<a.length;++b){var c=a[b].match(u);if(c){var e=c[2],d=c[3],c=c[5],e=s[e]||e;c&&(e=[e,parseInt(c,10)]);this.uniformTypes[d]=e}}},syncVariable:function(a){return this.recSyncVariable(a,this.variables[a],this.uniformTypes[a],a)},recSyncVariable:function(a,b,c,e){var d=this.gl;if(c){a=c instanceof Array;var f;a&&(f=
c[1],c=c[0]);var g=this.locations[e];if(c in this.structTypes)if(d=this.structTypes[c],a)for(a=0;a<f&&a<b.length;++a){var g=e+"["+a+"].",j=b[a],h;for(h in d){if(!(h in j)){l("variable '"+e+"["+a+"]' ("+c+") has no field '"+h+"'");break}var k=d[h];this.recSyncVariable(h,j[h],k,g+h)}}else for(h in g=e+".",d){if(!(h in b)){l("variable '"+e+"' ("+c+") has no field '"+h+"'");break}k=d[h];this.recSyncVariable(h,b[h],k,g+h)}else switch(f=c,a&&(f+="v"),h="uniform"+f,f){case "2f":case "2i":d[h].call(d,g,b.x,
b.y);break;case "3f":case "3i":d[h].call(d,g,b.x,b.y,b.z);break;case "4f":case "4i":d[h].call(d,g,b.x,b.y,b.z,b.w);break;case "sampler2D":this.syncTexture(d,g,b,e);break;default:d[h]?d[h].call(d,g,b):q("type '"+c+"' not found.")}}else l("variable '"+a+"' not found in your GLSL.")},syncTexture:function(a,b,c,e){var d=this.textureUnitForNames[e];d||(d=this.allocTexture(e));a.activeTexture(a.TEXTURE0+d);c=this.createTexture(c);a.bindTexture(a.TEXTURE_2D,c);a.uniform1i(b,d)},allocTexture:function(a){var b=
this.textureUnitCounter;this.textureUnitForNames[a]=b;this.textureUnitCounter++;return b},createTexture:function(a){var b=this.gl,c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);b.bindTexture(b.TEXTURE_2D,
null);return c},initUniformLocations:function(){this.locations={};for(var a in this.uniformTypes)this.recBindLocations(a,this.uniformTypes[a],a)},recBindLocations:function(a,b,c){a=b instanceof Array;var e;a&&(e=b[1],b=b[0]);if(b in this.structTypes)if(b=this.structTypes[b],a)for(a=0;a<e;++a){var d=c+"["+a+"].",f;for(f in b)this.recBindLocations(f,b[f],d+f)}else for(f in d=c+".",b)this.recBindLocations(f,b[f],d+f);else this.locations[c]=this.gl.getUniformLocation(this.program,c)},getWebGLContext:function(){return r(this.canvas)},
syncResolution:function(){var a=this.gl,b=this.canvas.width,c=this.canvas.height;a.viewport(0,0,b,c);var e=a.getUniformLocation(this.program,"resolution");a.uniform2f(e,b,c);a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,b,0,0,c,0,c,b,0,b,c]),a.STATIC_DRAW)},load:function(){var a=this.gl;this.program&&(a.deleteProgram(this.program),this.program=null);this.program=this.loadProgram([this.loadShader("attribute vec2 position;attribute vec2 texCoord_in;uniform vec2 resolution;varying vec2 texCoord;void main() {vec2 zeroToOne = position / resolution;vec2 zeroToTwo = zeroToOne * 2.0;vec2 clipSpace = zeroToTwo - 1.0;gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);texCoord = texCoord_in;}",
a.VERTEX_SHADER),this.loadShader(this.fragment,a.FRAGMENT_SHADER)]);a.useProgram(this.program);this.initUniformLocations();this.textureUnitForNames={};this.textureUnitCounter=0;var b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),a.STATIC_DRAW);b=a.getAttribLocation(this.program,"texCoord_in");a.enableVertexAttribArray(b);a.vertexAttribPointer(b,2,a.FLOAT,!1,0,0);b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);b=a.getAttribLocation(this.program,
"position");a.enableVertexAttribArray(b);a.vertexAttribPointer(b,2,a.FLOAT,!1,0,0);this.syncResolution()},loadProgram:function(a){var b=this.gl,c=b.createProgram();a.forEach(function(a){b.attachShader(c,a)});b.linkProgram(c);if(!b.getProgramParameter(c,b.LINK_STATUS))throw b.deleteProgram(c),Error(c+" "+b.getProgramInfoLog(c));return c},loadShader:function(a,b){var c=this.gl,e=c.createShader(b);c.shaderSource(e,a);c.compileShader(e);if(!c.getShaderParameter(e,c.COMPILE_STATUS)){lastError=c.getShaderInfoLog(e);
var d=lastError.split(":"),f=parseInt(d[1],10),d=parseInt(d[2],10),g="";if(!isNaN(f)){for(var g="",j=0;j<f;++j)g+=" ";g="\n"+g+"^"}q(lastError+"\n"+a.split("\n")[d-1]+g);c.deleteShader(e);throw Error(e+" "+lastError);}return e}};for(var t=0,p=["ms","moz","webkit","o"],k=0;k<p.length&&!window.requestAnimationFrame;++k)window.requestAnimationFrame=window[p[k]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[p[k]+"CancelAnimationFrame"]||window[p[k]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||
(window.requestAnimationFrame=function(a){var b=(new Date).getTime(),c=Math.max(0,16-(b-t)),e=window.setTimeout(function(){a(b+c)},c);t=b+c;return e});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})})();
