<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pong</title>
  <style type="text/css">
    body {
      background: #000;
      color: #fff;
    }
    #wrapper {
      width: 600px;
      margin: 20px auto;
    }
  </style>
</head>
<body>

  <div id="wrapper">
    <h1>Pong</h1>
    <canvas id="viewport" width="600" height="400"></canvas>
  </div>

  <script src="../lib/Stats.js" type="text/javascript"></script>
  <script src="../lib/rAF.js" type="text/javascript"></script>
  <script src="../lib/Loader.js" type="text/javascript"></script>
  <script src="../lib/jsfx/audio.js" type="text/javascript"></script>
  <script src="../lib/jsfx/jsfx.js" type="text/javascript"></script>
  <script src="../lib/jsfx/jsfxlib.js" type="text/javascript"></script>

  <script src="../../glsl.js" type="text/javascript"></script>
  <script type="text/javascript">
var STATS = new Stats(); document.getElementById("wrapper").appendChild(STATS.domElement);

var beep1 = jsfxlib.createWave(["square",0.0000,0.4000,0.0000,0.1280,0.0000,0.2660,408.0000,506.0000,578.0000,-0.9980,-0.1480,0.0000,3.3693,0.0003,0.0000,0.0460,0.8560,0.2835,0.1580,0.0000,-0.1760,0.0040,0.9990,0.1020,0.0000,0.0000,0.0000]);
var beep2 = jsfxlib.createWave(["square",0.0000,0.4000,0.0000,0.1280,0.0000,0.2660,408.0000,331.0000,578.0000,-0.9980,-0.1480,0.0000,3.3693,0.0003,0.0000,0.0460,0.8560,0.2835,0.1580,0.0000,-0.1760,0.0040,0.9990,0.1020,0.0000,0.0000,0.0000]);

Loader.text("main.frag", function (mainFrag) {
    var canvas = document.getElementById("viewport");

    var BALL_RADIUS = 0.01;
    var PLAYER_DIMENSION = { x: 0.02, y: 0.2 };

    // Game states
    var startTime = +new Date();
    var lastUpdate = 0;
    var mouseP = { x: 0, y: 0.5 };
    var ballVelocity = { x: 0, y: 0 };
    var playerSendBall = false;
    var playerHasBall = true;
    var computerSendBall = false;
    var computerHasBall = false;
    var playerCount = 0;
    var computerCount = 0;

    canvas.addEventListener("mousemove", function (e) {
      mouseP = { x: e.offsetX, y: e.offsetY };
    }, false);

    canvas.addEventListener("click", function (e) {
      playerSendBall = true;
    });

    function ballCollidePlayer (player, ball) {
      return player.x-PLAYER_DIMENSION.x/2 <= ball.x+BALL_RADIUS &&
        ball.x-BALL_RADIUS <= player.x+PLAYER_DIMENSION.x/2 &&
        player.y-PLAYER_DIMENSION.y/2 <= ball.y+BALL_RADIUS &&
        ball.y-BALL_RADIUS <= player.y+PLAYER_DIMENSION.y/2;
    }

    function constraintPlayerY (y) {
      return Math.max(PLAYER_DIMENSION.y/2, Math.min(y, 1-PLAYER_DIMENSION.y/2));
    }

    var lastDecision = 0;
    var moveTargetY = 0.5;
    var moveSpeed = 0.1;
    function computerAI (pos, ball) {
      var now = Date.now();
      var t = now - lastDecision;
      if (t > 500) {
        lastDecision = now;
        if (computerHasBall) {
          computerSendBall = true;
        }
      }
      moveTargetY = ball.y;
      if (!computerHasBall && !playerHasBall) {
        var delta = pos.y - moveTargetY;
        pos.y = constraintPlayerY(pos.y - delta * moveSpeed);
      }
    }

    var lastPlay = 0;
    function play (sound) {
      if (Date.now() - lastPlay < 100) return;
      lastPlay = Date.now();
      sound.play();
    }

    var glsl = Glsl({
      canvas: canvas,
      fragment: mainFrag,
      variables: {
        BALL_RADIUS: BALL_RADIUS,
        PLAYER_DIMENSION: PLAYER_DIMENSION,
        time: 0,
        computerCount: computerCount,
        playerCount: playerCount,
        player: { x: 0.02, y: 0.5 },
        computer: { x: 0.98, y: 0.5 },
        ball: { x: 0.05, y: 0.5 },
        playerShake: { x: 0, y: 0 }
      },
      update: function () {
        STATS.begin();
        var t = (+new Date() - startTime)/1000;
        var tdiff = t-lastUpdate;
        lastUpdate = t;
        var playery = constraintPlayerY(1 - mouseP.y / canvas.height);
        if (playerSendBall) {
          playerSendBall = false;
          if (playerHasBall) {
            playerHasBall = false;
            ballVelocity = { x: 0.5+0.1*Math.random(), y: 1.*(0.5-Math.random()) };
          }
        }
        if (computerSendBall) {
          computerSendBall = false;
          if (computerHasBall) {
            computerHasBall = false;
            ballVelocity = { x: -0.5-0.1*Math.random(), y: 1.*(0.5-Math.random()) };
          }
        }
        var ball = this.variables.ball;

        if (playerHasBall) {
          ball.y = playery;
        }

        if (ball.y < BALL_RADIUS || ball.y > 1-BALL_RADIUS) {
          ballVelocity.y *= -1;
        }
        
        if (ballCollidePlayer(ball, this.variables.player)) {
          ballVelocity.x = Math.abs(ballVelocity.x);
          var dy = ball.y - this.variables.player.y;
          ballVelocity.y += 10*dy;
          play(beep1);
        }
        if (ballCollidePlayer(ball, this.variables.computer)) {
          ballVelocity.x = -Math.abs(ballVelocity.x);
          var dy = ball.y - this.variables.computer.y;
          ballVelocity.y += 10*dy;
          play(beep2);
        }

        ball.x += ballVelocity.x * tdiff;
        ball.y += ballVelocity.y * tdiff;

        if (ball.x > 1.0) {
          ballVelocity = { x: 0, y: 0 };
          ball.x = 0.05;
          ball.y = this.variables.player.y;
          playerHasBall = true;
          playerCount ++;
          this.variables.playerCount = playerCount;
          this.sync("computerCount");
        }

        if (ball.x < 0.0) {
          ballVelocity = { x: 0, y: 0 };
          ball.x = 0.95;
          ball.y = this.variables.computer.y;
          computerHasBall = true;
          computerCount ++;
          this.variables.computerCount = computerCount;
          this.sync("computerCount");
        }

        computerAI(this.variables.computer, ball);

        this.variables.time = t;
        this.variables.player.y = playery;
        this.variables.ball = ball;
        this.variables.playerShake = playerHasBall ? { x: .01*Math.random(), y: .01*Math.random() } : { x: 0, y: 0 };

        this.sync("time", "player", "playerShake", "ball", "computer");
        STATS.end();
      }
    }).start();
});
  </script>
</body>
</html>
