(function(j){function h(a){if(!(this instanceof arguments.callee))return new arguments.callee(a);for(var b=0;b<g.length;b++)if(!(g[b]in a))throw"Glsl: option '"+g[b]+"' is required.";this.canvas=a.canvas;this.variables=a.variables;this.locations={};this.update=a.update||function(){};this.fragment=a.fragment;this.inferTypes();if(!this.types.resolution)throw"You must use a 'vec2 resolution' in your shader.";delete this.types.resolution;this.initGL()}var g=["fragment","canvas","variables"],k={bool:"1i",
"int":"1i","float":"1f",vec2:"2f",ivec2:"2i",bvec2:"2b",vec3:"3f",ivec3:"3i",bvec3:"3b",vec4:"4f",ivec4:"4i",bvec4:"4b",mat2:"Matrix2fv",mat3:"Matrix3fv",mat4:"Matrix4fv"};h.prototype={start:function(){var a=this;this.syncAll();a.update();a.render();this.running=!0;requestAnimationFrame(function c(){this.stopRequest?this.running=this.stopRequest=!1:(requestAnimationFrame(c,a.canvas),a.update(),a.render())},a.canvas);return this},stop:function(){this.stopRequest=!0},inferTypes:function(){var a=this.fragment.split("\n"),
b=/uniform\s+([A-Za-z0-9]+)\s+([a-zA-Z_0-9]+)\s*(\[([0-9]+)\])?/;this.types={};this.typesArrayLength={};for(var c=0;c<a.length;++c){var d=a[c].match(b);if(d){var e=k[d[1]]||d[1],f=d[2];d[4]&&(this.typesArrayLength[name]=parseInt(d[4],10),e+="v");this.types[f]=e}}},initGL:function(){var a=this;this.canvas.addEventListener("webglcontextlost",function(a){a.preventDefault()},!1);this.canvas.addEventListener("webglcontextrestored",function(){a.running&&a.syncAll();a.load()},!1);this.gl=this.getWebGLContext(this.canvas);
this.load()},render:function(){this.gl.drawArrays(this.gl.TRIANGLES,0,6)},sync:function(){for(var a=0;a<arguments.length;++a)this.syncVariable(arguments[a])},syncAll:function(){for(var a in this.variables)this.syncVariable(a)},syncVariable:function(a){var b=this.gl,c=this.types[a];if(!c)throw"Variable '"+a+"' not found in your GLSL.";var d=this.locations[a],e=this.variables[a],f="uniform"+c;switch(c){case "2f":case "2i":b[f].call(b,d,e.x,e.y);break;case "3f":case "3i":b[f].call(b,d,e.x,e.y,e.z);break;
case "4f":case "4i":b[f].call(b,d,e.x,e.y,e.z,e.w);break;case "sampler2D":this.syncTexture(b,d,e,a);break;default:b[f].call(b,d,e)}},syncTexture:function(a,b,c,d){d=this.textureUnitForNames[d];a.activeTexture(a.TEXTURE0+d);c=this.createTexture(c);a.bindTexture(a.TEXTURE_2D,c);a.uniform1i(b,d)},allocTexture:function(a){this.textureUnitForNames[a]=this.currentTextureUnit;this.currentTextureUnit++},createTexture:function(a){var b=this.gl,c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);b.texImage2D(b.TEXTURE_2D,
0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);b.bindTexture(b.TEXTURE_2D,null);return c},bindUniformLocations:function(){for(var a in this.types)this.locations[a]=this.gl.getUniformLocation(this.program,a)},getWebGLContext:function(){if(this.canvas.getContext)for(var a=
["webgl","experimental-webgl"],b=0;b<a.length;++b)try{var c=this.canvas.getContext(a[b]);if(c)return c}catch(d){}},syncResolution:function(){var a=this.gl,b=this.canvas.width,c=this.canvas.height;a.viewport(0,0,b,c);var d=a.getUniformLocation(this.program,"resolution");a.uniform2f(d,b,c);a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,b,0,0,c,0,c,b,0,b,c]),a.STATIC_DRAW)},load:function(){var a=this.gl;this.program&&(a.deleteProgram(this.program),this.program=null,this.locations={});this.program=
this.loadProgram([this.loadShader("attribute vec2 position;attribute vec2 texCoord_in;uniform vec2 resolution;varying vec2 texCoord;void main() {vec2 zeroToOne = position / resolution;vec2 zeroToTwo = zeroToOne * 2.0;vec2 clipSpace = zeroToTwo - 1.0;gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);texCoord = texCoord_in;}",a.VERTEX_SHADER),this.loadShader(this.fragment,a.FRAGMENT_SHADER)]);a.useProgram(this.program);this.bindUniformLocations();this.textureUnitForNames={};this.currentTextureUnit=
0;for(var b in this.types)"sampler2D"==this.types[b]&&this.allocTexture(b);b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),a.STATIC_DRAW);b=a.getAttribLocation(this.program,"texCoord_in");a.enableVertexAttribArray(b);a.vertexAttribPointer(b,2,a.FLOAT,!1,0,0);b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);b=a.getAttribLocation(this.program,"position");a.enableVertexAttribArray(b);a.vertexAttribPointer(b,2,a.FLOAT,!1,0,0);
this.syncResolution()},loadProgram:function(a){var b=this.gl,c=b.createProgram();a.forEach(function(a){b.attachShader(c,a)});b.linkProgram(c);if(!b.getProgramParameter(c,b.LINK_STATUS))throw"Linking error:"+b.getProgramInfoLog(c);return c},loadShader:function(a,b){var c=this.gl,d=c.createShader(b);c.shaderSource(d,a);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS))throw lastError=c.getShaderInfoLog(d),console.error&&(c=lastError.split(":")[2])&&console.error("Error for line "+c+": "+
a.split("\n")[c]),d+"':"+lastError;return d}};j.Glsl=h})(window);
