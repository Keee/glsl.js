(function(){function l(a){console.warn?console.warn(m+a):console.log&&console.log(m+("WARN "+a))}function q(a){console.error?console.error(m+a):console.log&&console.log(m+("ERR "+a))}function r(a){if(a.getContext)for(var b=["webgl","experimental-webgl"],c=0;c<b.length;++c)try{var d=a.getContext(b[c]);if(d)return d}catch(e){}}var n=["fragment","canvas","variables"],s={bool:"1i","int":"1i","float":"1f",vec2:"2f",ivec2:"2i",bvec2:"2b",vec3:"3f",ivec3:"3i",bvec3:"3b",vec4:"4f",ivec4:"4i",bvec4:"4b",mat2:"Matrix2fv",
mat3:"Matrix3fv",mat4:"Matrix4fv"},u=/uniform\s+([a-z]+\s+)?([A-Za-z0-9]+)\s+([a-zA-Z_0-9]+)\s*(\[([0-9]+)\])?/,v=/struct\s+\w+\s*{[^}]+}\s*;/g,w=/struct\s+(\w+)\s*{([^}]+)}\s*;/,x=/[^;]+;/g,y=/\s*([a-z]+\s+)?([A-Za-z0-9]+)\s+([a-zA-Z_0-9]+)\s*(\[([0-9]+)\])?\s*;/,m="Glsl: ";this.Glsl=function(a){if(!(this instanceof arguments.callee))return new arguments.callee(a);if(!a)throw Error("Glsl: {"+n+"} are required.");for(var b=0;b<n.length;b++)if(!(n[b]in a))throw Error("Glsl: '"+n[b]+"' is required.");
this.canvas=a.canvas;this.fragment=a.fragment;this.variables=a.variables;this.update=a.update||function(){};this.parseStructs();this.parseUniforms();if(!this.uniformTypes.resolution)throw Error("Glsl: You must use a 'vec2 resolution' in your shader.");delete this.uniformTypes.resolution;for(var c in this.uniformTypes)c in this.variables||l("variable '"+c+"' not initialized");this.initGL();this.load();this.syncAll();this.update(0);this.render()};Glsl.supported=function(){return!!r(document.createElement("canvas"))};
Glsl.prototype={start:function(){var a=Date.now(),b=a,c=this;this.running=!0;requestAnimationFrame(function e(){if(this.stopRequest)this.running=this.stopRequest=!1;else{requestAnimationFrame(e,c.canvas);var f=Date.now()-a,g=f-b;b=f;c.update(f,g);c.render()}},c.canvas);return this},stop:function(){this.stopRequest=!0},sync:function(){for(var a=0;a<arguments.length;++a)this.syncVariable(arguments[a])},syncAll:function(){for(var a in this.variables)this.syncVariable(a)},set:function(a,b){this.variables[a]=
b;this.sync(a)},initGL:function(){var a=this;this.canvas.addEventListener("webglcontextlost",function(a){a.preventDefault()},!1);this.canvas.addEventListener("webglcontextrestored",function(){a.running&&a.syncAll();a.load()},!1);this.gl=this.getWebGLContext(this.canvas)},render:function(){this.gl.drawArrays(this.gl.TRIANGLES,0,6)},parseStructs:function(){this.structTypes={};var a=this.fragment.match(v);if(a)for(var b=0;b<a.length;++b){for(var c=a[b].match(w),d=c[1],c=c[2].match(x),e={},f=0;f<c.length;++f){var g=
c[f].match(y),h=g[2],j=g[3],g=g[4],h=s[h]||h;g&&(h=[h,parseInt(g,10)]);e[j]=h}this.structTypes[d]=e}},parseUniforms:function(){this.uniformTypes={};for(var a=this.fragment.split("\n"),b=0;b<a.length;++b){var c=a[b].match(u);if(c){var d=c[2],e=c[3],c=c[5],d=s[d]||d;c&&(d=[d,parseInt(c,10)]);this.uniformTypes[e]=d}}},syncVariable:function(a){return this.recSyncVariable(a,this.variables[a],this.uniformTypes[a],a)},recSyncVariable:function(a,b,c,d){var e=this.gl;if(c){var f=c instanceof Array,g;f&&(g=
c[1],c=c[0]);var h=this.locations[d];if(c in this.structTypes)if(a=this.structTypes[c],f)for(e=0;e<g;++e){var f=d+"["+e+"].",h=b[e],j;for(j in a){if(!(j in h)){l("variable '"+d+"' ("+c+") has no field '"+j+"'");break}var k=a[j];this.recSyncVariable(j,h[j],k,f+j)}}else for(j in f=d+".",a){if(!(j in b)){l("variable '"+d+"' ("+c+") has no field '"+j+"'");break}k=a[j];this.recSyncVariable(j,b[j],k,f+j)}else switch(d=c,f&&(d+="v"),g="uniform"+d,d){case "2f":case "2i":e[g].call(e,h,b.x,b.y);break;case "3f":case "3i":e[g].call(e,
h,b.x,b.y,b.z);break;case "4f":case "4i":e[g].call(e,h,b.x,b.y,b.z,b.w);break;case "sampler2D":this.syncTexture(e,h,b,a);break;default:e[g]?e[g].call(e,h,b):q("type '"+c+"' not found.")}}else l("variable '"+a+"' not found in your GLSL.")},syncTexture:function(a,b,c,d){d=this.textureUnitForNames[d];a.activeTexture(a.TEXTURE0+d);c=this.createTexture(c);a.bindTexture(a.TEXTURE_2D,c);a.uniform1i(b,d)},allocTexture:function(a){this.textureUnitForNames[a]=this.textureUnitCounter;this.textureUnitCounter++},
createTexture:function(a){var b=this.gl,c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);b.bindTexture(b.TEXTURE_2D,null);return c},initUniformLocations:function(){this.locations={};for(var a in this.uniformTypes)this.recBindLocations(a,
this.uniformTypes[a],a)},recBindLocations:function(a,b,c){a=b instanceof Array;var d;a&&(d=b[1],b=b[0]);if(b in this.structTypes)if(b=this.structTypes[b],a)for(a=0;a<d;++a){var e=c+"["+a+"].",f;for(f in b)this.recBindLocations(f,b[f],e+f)}else for(f in e=c+".",b)this.recBindLocations(f,b[f],e+f);else this.locations[c]=this.gl.getUniformLocation(this.program,c)},getWebGLContext:function(){return r(this.canvas)},syncResolution:function(){var a=this.gl,b=this.canvas.width,c=this.canvas.height;a.viewport(0,
0,b,c);var d=a.getUniformLocation(this.program,"resolution");a.uniform2f(d,b,c);a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,b,0,0,c,0,c,b,0,b,c]),a.STATIC_DRAW)},load:function(){var a=this.gl;this.program&&(a.deleteProgram(this.program),this.program=null);this.program=this.loadProgram([this.loadShader("attribute vec2 position;attribute vec2 texCoord_in;uniform vec2 resolution;varying vec2 texCoord;void main() {vec2 zeroToOne = position / resolution;vec2 zeroToTwo = zeroToOne * 2.0;vec2 clipSpace = zeroToTwo - 1.0;gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);texCoord = texCoord_in;}",
a.VERTEX_SHADER),this.loadShader(this.fragment,a.FRAGMENT_SHADER)]);a.useProgram(this.program);this.initUniformLocations();this.textureUnitForNames={};this.textureUnitCounter=0;for(var b in this.uniformTypes)"sampler2D"==this.uniformTypes[b]&&this.allocTexture(b);b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),a.STATIC_DRAW);b=a.getAttribLocation(this.program,"texCoord_in");a.enableVertexAttribArray(b);a.vertexAttribPointer(b,
2,a.FLOAT,!1,0,0);b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);b=a.getAttribLocation(this.program,"position");a.enableVertexAttribArray(b);a.vertexAttribPointer(b,2,a.FLOAT,!1,0,0);this.syncResolution()},loadProgram:function(a){var b=this.gl,c=b.createProgram();a.forEach(function(a){b.attachShader(c,a)});b.linkProgram(c);if(!b.getProgramParameter(c,b.LINK_STATUS))throw b.deleteProgram(c),Error(c+" "+b.getProgramInfoLog(c));return c},loadShader:function(a,b){var c=this.gl,d=c.createShader(b);
c.shaderSource(d,a);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS)){lastError=c.getShaderInfoLog(d);var e=lastError.split(":"),f=parseInt(e[1],10),e=e[2],g="";if(!isNaN(f)){for(var g="",h=0;h<f;++h)g+=" ";g="\n"+g+"^"}q(lastError+"\n"+a.split("\n")[e]+g);c.deleteShader(d);throw Error(d+" "+lastError);}return d}};for(var t=0,p=["ms","moz","webkit","o"],k=0;k<p.length&&!window.requestAnimationFrame;++k)window.requestAnimationFrame=window[p[k]+"RequestAnimationFrame"],window.cancelAnimationFrame=
window[p[k]+"CancelAnimationFrame"]||window[p[k]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var b=(new Date).getTime(),c=Math.max(0,16-(b-t)),d=window.setTimeout(function(){a(b+c)},c);t=b+c;return d});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})})();
